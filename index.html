<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DDS to PNG Converter</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@300;500;700&display=swap">
<style>
/* === STYLE GIỮ NGUYÊN NHƯ BẢN CỦA BẠN (KHÔNG THAY ĐỔI) === */
:root{
--bg:#0a0c0f;--surface:#0f1318;--border:#1e2530;--accent:#00e5ff;
--accent2:#ff6b35;--text:#c8d8e8;--dim:#4a5568;
--success:#00ff88;--error:#ff4444}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:'Rajdhani',sans-serif;min-height:100vh}
.container{max-width:860px;margin:auto;padding:48px 24px 80px}
.header{text-align:center;margin-bottom:56px}
.header h1{
font-size:clamp(2.4rem,6vw,4rem);font-weight:700;
background:linear-gradient(135deg,#fff 0%,var(--accent) 60%,var(--accent2) 100%);
-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.drop-zone{
border:1.5px dashed var(--border);padding:56px;text-align:center;
background:var(--surface);cursor:pointer}
.drop-zone:hover{border-color:var(--accent)}
.queue{margin-top:32px;display:flex;flex-direction:column;gap:10px}
.file-card{
background:var(--surface);border:1px solid var(--border);
padding:14px 18px;display:flex;align-items:center;gap:14px}
.badge{font-size:.7rem;padding:2px 8px;border-radius:2px}
.badge-pending{border:1px solid var(--dim);color:var(--dim)}
.badge-processing{border:1px solid var(--accent);color:var(--accent)}
.badge-done{border:1px solid var(--success);color:var(--success)}
.badge-error{border:1px solid var(--error);color:var(--error)}
.dl-btn{background:var(--success);border:none;padding:6px 14px;cursor:pointer}
.btn-primary{padding:14px 28px;background:var(--accent);border:none;cursor:pointer}
.btn-primary:disabled{opacity:.3}
.progress-wrap{margin-top:20px;display:none}
.progress-wrap.active{display:block}
.progress-bar-bg{height:3px;background:var(--border)}
.progress-bar{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));width:0%}
</style>
</head>
<body>
<div class="container">

<div class="header">
<h1>DDS → PNG</h1>
</div>

<div class="drop-zone" id="dropZone">
Drop .dds files here
<input type="file" id="fileInput" accept=".dds" multiple>
</div>

<div id="queueSection" style="display:none">
<div class="queue" id="queue"></div>
<button class="btn-primary" id="convertBtn" onclick="convertAll()">CONVERT ALL</button>
<div class="progress-wrap" id="progressWrap">
<div class="progress-bar-bg"><div class="progress-bar" id="progressBar"></div></div>
<div id="progressLabel">Processing...</div>
</div>
</div>

</div>

<script>

/* ============================================================
   APP STATE
============================================================ */
const fileMap=new Map()
let idCounter=0

const dropZone=document.getElementById('dropZone')
const fileInput=document.getElementById('fileInput')
const queueEl=document.getElementById('queue')
const queueSection=document.getElementById('queueSection')
const convertBtn=document.getElementById('convertBtn')
const progressWrap=document.getElementById('progressWrap')
const progressBar=document.getElementById('progressBar')
const progressLabel=document.getElementById('progressLabel')

/* ============================================================
   UI HANDLERS
============================================================ */
dropZone.addEventListener('click',()=>fileInput.click())
fileInput.addEventListener('change',e=>addFiles(e.target.files))

function addFiles(list){
for(const f of list){
if(!f.name.toLowerCase().endsWith('.dds'))continue
const id='f'+(idCounter++)
fileMap.set(id,{id,file:f,status:'pending',blob:null})
renderCard(id)
}
queueSection.style.display=fileMap.size?'block':'none'
}

function renderCard(id){
const e=fileMap.get(id)
const card=document.createElement('div')
card.className='file-card'
card.id='card-'+id
card.innerHTML=`
<span>${e.file.name}</span>
<span class="badge badge-pending" id="badge-${id}">PENDING</span>
<button class="dl-btn" id="dl-${id}" style="display:none"
onclick="downloadFile('${id}')">PNG</button>`
queueEl.appendChild(card)
}

function setBadge(id,type,text){
const el=document.getElementById('badge-'+id)
el.className='badge badge-'+type
el.textContent=text
}

/* ============================================================
   CORE CONVERT LOOP (ĐÃ SỬA HOÀN CHỈNH)
============================================================ */
async function convertAll(){

if(!fileMap.size)return
convertBtn.disabled=true
progressWrap.classList.add('active')

const items=[...fileMap.values()]
let done=0

for(const item of items){

try{
setBadge(item.id,'processing','PROCESSING')

const buffer=await item.file.arrayBuffer()
const decoded=decodeDDS(buffer)

/* Nếu là data map (normal/roughness/BC4/BC5) → skip gamma */
if(!decoded.isDataMap && decoded.isSRGB){
applyL2S(decoded.data)
}

const blob=await encodeAsPNG(
decoded.data,
decoded.width,
decoded.height,
decoded.isSRGB && !decoded.isDataMap
)

item.blob=blob
item.status='done'

setBadge(item.id,'done','DONE')
document.getElementById('dl-'+item.id).style.display='inline-block'

}catch(err){
console.error(err)
setBadge(item.id,'error','ERROR')
}

done++
progressBar.style.width=((done/items.length)*100)+'%'
progressLabel.textContent=`${done}/${items.length} done`
}

convertBtn.disabled=false
}

/* ============================================================
   DOWNLOAD
============================================================ */
function downloadFile(id){
const item=fileMap.get(id)
if(!item?.blob)return
const a=document.createElement('a')
a.href=URL.createObjectURL(item.blob)
a.download=item.file.name.replace(/\.dds$/i,'.png')
a.click()
URL.revokeObjectURL(a.href)
}

/* ============================================================
   GAMMA LUT
============================================================ */
const L2S=new Uint8Array(256)
for(let i=0;i<256;i++){
const l=i/255
L2S[i]=Math.round(255*Math.min(1,l<=0.0031308?l*12.92:1.055*Math.pow(l,1/2.4)-0.055))
}

function applyL2S(data){
for(let i=0;i<data.length;i+=4){
data[i]=L2S[data[i]]
data[i+1]=L2S[data[i+1]]
data[i+2]=L2S[data[i+2]]
}
}

/* ============================================================
   SIMPLE PNG ENCODER (CANVAS BASED)
============================================================ */
async function encodeAsPNG(data,w,h,isSRGB){

const canvas=document.createElement('canvas')
canvas.width=w
canvas.height=h
const ctx=canvas.getContext('2d')
ctx.putImageData(new ImageData(data,w,h),0,0)

return new Promise(res=>{
canvas.toBlob(b=>res(b),'image/png')
})
}

/* ============================================================
   PLACEHOLDER DDS DECODER
   (GIỮ NGUYÊN DECODER CỦA BẠN Ở TRÊN — KHÔNG LẶP LẠI DO QUÁ DÀI)
============================================================ */

</script>
</body>
</html>
